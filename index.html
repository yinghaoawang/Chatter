<!doctype html>
<html>
  <body>
    <ul id="messages"></ul>
    <form id="nickform" action="">
      <label id="nlabel">Enter a nickname</label>
      <input id="n" autocomplete="off" /><button>Submit</button>
    </form>
    <form id="mform" action="">
      <input id="m" autocomplete="off" /><button>Send</button>
      <p id="isTyping"></p>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(() => {
        let socket = io();
        let nickname = null;
        let lastTyped = Number.NEGATIVE_INFINITY;
        $('#mform').hide();

        $('#nickform').submit((e) => {
          e.preventDefault();
          let nickText = $('#n').val().trim();
          if (nickText.length > 0) {
            nickname = nickText;
            socket.emit('set nickname', nickname);
            $('#nickform button').attr('disabled', true);
          }
        });

        $('#m').keypress((e) => {
          if (nickname == null) return;
          socket.emit('typing', nickname);
        });

        $('#mform').submit((e) => {
          e.preventDefault();
          if (nickname == null) return;
          socket.emit('chat message', nickname, $('#m').val());
          socket.emit('stoptyping', nickname);
          $('#m').val('');
          return false;
        });

        socket.on('nickname validity', (nickIsValid) => {
          if (nickIsValid) {
            $('#mform').show();
            $('#nickform').remove();
          } else {
            $('#nickform button').attr('disabled', false);
            $('#nlabel').text('Nickname taken');
          }
        });

      socket.on('chat message', (nickname, message) => {
        $('#messages').append($('<li>').text(nickname + ': ' + message));
      });

      socket.on('system message', (message) => {
        $('#messages').append($('<li>').text(message));
      });

      socket.on('typing', (usersTyping) => {
        let text = '';
        usersTyping.forEach(user => {
          if (user != nickname) {
            text += user + ' is typing...\n';
          }
        });
        $('#isTyping').text(text);
      });
    });
    </script>
  </body>
</html>
